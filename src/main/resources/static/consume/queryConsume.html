<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>查询消费页面</title>
    <link rel="stylesheet" type="text/css" href="/css/pure-min.css">
    <script type="text/javascript">
        /**
         * 初始化页面加载当前用户的全部消费记录
         */
        window.onload = function () {
            const userDivUrl = "/vcoffee/user/findUserById";
            const userXhr = new XMLHttpRequest();
            const queryUserParam = {};
            userXhr.open("POST",userDivUrl,true);
            userXhr.setRequestHeader("content-Type","application/json");
            userXhr.onload = function () {
              let res = JSON.parse(userXhr.responseText);
              if(res.code === 1000){
                  console.log(res.message);
                  if(res.data.isAdmin == 2){
                      let normal = document.getElementById("normal");
                      normal.hidden = true;
                  }else{
                      let companyName = document.getElementById("companyName");
                      companyName.value = res.data.companyName;
                      companyName.innerHTML = res.data.companyName;
                  }
                  let userName = document.getElementById("userName");
                  userName.value = res.data.username;
                  userName.innerHTML = res.data.username;
              }else{
                  console.error("消费记录页面查找用户信息报错，" + res.message);
                  window.location.href = "/error/error.html";
              }
            };
            userXhr.onerror = function () {
                console.error("消费记录页面查找用户信息报错，" + JSON.parse(userXhr.responseText).message);
                window.location.href = "/error/error.html";
            };
            userXhr.send();

            const url = "/vcoffee/consume/queryAllConsumes";
            const xhr = new XMLHttpRequest();
            const queryParam = {
              "page":{
                  "currentPage":1,
                  "limit":10
              }
            };
            xhr.open("POST",url,true);
            xhr.setRequestHeader("content-Type","application/json");
            xhr.onload = function () {
              let res = JSON.parse(xhr.responseText);
              if(res.code === 1000){
                  console.log(res.message);

                  drawConsumeTbody(res);
                  drawConsumePageDiv(res);
              }else{
                  console.error("初始化页面加载当前用户的消费记录报错," + res.message);
                  // window.location.href = "/error/error.html";
              }
            };
            xhr.onerror = function () {
                console.error("初始化页面加载当前用户的消费记录报错," + JSON.parse(xhr.responseText).message);
                window.location.href = "/error/error.html";
            };
            xhr.send(JSON.stringify(queryParam));
        };
        /**
         * 按日期条件查询消费记录
         */
        function queryConsume() {
           const startDate = document.getElementById("startDate").value;
           const endDate = document.getElementById("endDate").value;
           const url = "/vcoffee/consume/queryConsume";
           const xhr = new XMLHttpRequest();
           const queryParam = {
             "startDate":startDate,
             "endDate":endDate,
             "page":{
                 "currentPage":1,
                 "limit":10
             }
           };
           xhr.open("POST",url,true);
           xhr.setRequestHeader("content-Type","application/json");
           xhr.onload = function () {
             let res = JSON.parse(xhr.responseText);
             if(res.code === 1000){
                 console.log(res.message);
                 clearConsumeTbody();
                 drawConsumeTbody(res);
                 clearConsumePageDiv();
                 drawConsumePageDivWithOption(res);
             }else{
                 console.error("条件查询消费记录报错，" + res.message);
                 window.location.href = "/error/error.html";
             }
           };
           xhr.onerror = function () {
               console.error("条件查询消费记录报错，" + JSON.parse(xhr.responseText).message);
               window.location.href = "/error/error.html";
           };
            xhr.send(JSON.stringify(queryParam));
        }

        /**
         * 初始化页面的时候加载当前用户的全部消费记录
         * @param res
         */
        function drawConsumeTbody(res) {
            console.log("后台传过来的数据总数是：" + res.data.length);
           for(let i = 0 ; i < res.data.length ; i++){
               let rowElement = document.createElement("tr");

               let checkboxCell = document.createElement("td");
               let checkBox = document.createElement("input");
               checkBox.setAttribute("type","checkbox");
               checkBox.setAttribute("name","idCheckBox");
               checkBox.setAttribute("id",res.data[i].id);
               checkboxCell.appendChild(checkBox);
               rowElement.appendChild(checkboxCell);

               let idCell = document.createElement("td");
               idCell.innerHTML = res.data[i].consumeNumber;
               rowElement.appendChild(idCell);

               let typeCell = document.createElement("td");
               typeCell.innerHTML = res.data[i].type;
               rowElement.appendChild(typeCell);

               let amountCell = document.createElement("td");
               amountCell.innerHTML = res.data[i].amount;
               rowElement.appendChild(amountCell);

               let operatorCell = document.createElement("td");
               operatorCell.innerHTML = res.data[i].operator;
               rowElement.appendChild(operatorCell);

               let operateDateCell = document.createElement("td");
               operateDateCell.innerHTML = res.data[i].operateDate;
               rowElement.appendChild(operateDateCell);

               let tbody = document.getElementById("consumeTbody");
               tbody.appendChild(rowElement);
           }
        }
        /**
         * 清除消费记录pageDiv中的内容
         */
        function clearConsumePageDiv() {
            let pageDiv = document.getElementById("pageDiv");
            pageDiv.innerText = "";
        }
        /**
         * 清空消费表格中内容
         */
        function clearConsumeTbody() {
            let tbody = document.getElementById("consumeTbody");
            tbody.innerText = "";
        }

        /**
         * 消费信息查询分页信息
         */
        function queryConsumePage() {
            clearConsumeTbody();
            const url = "/vcoffee/consume/findAllConsumes";
            const params = {
              "page":{
                  "currentPage":this.id,
                  "limit":10
              }
            };
            const xhr = new XMLHttpRequest();
            xhr.open("POST",url,true);
            xhr.setRequestHeader("content-Type","application/json");
            xhr.onload = function () {
              let res = JSON.parse(xhr.responseText);
              if(res.code === 1000){
                  console.log(res.message);
                  drawConsumeTbody(res);
              }else{
                  console.error("查询消费记录分页信息报错， " + res.message);
                  window.location.href = "/error/error.html";
              }
            };
            xhr.onerror = function () {
                console.error("查询消费记录分页信息报错， " + JSON.parse(xhr.responseText).message);
                window.location.href = "/error/error.html";
            };
            xhr.send(JSON.stringify(params));
        }

        /**
         * 初始化页面的时候加载当前用户的消费记录的分页信息
         * @param res
         */
        function drawConsumePageDiv(res) {
          let pageDiv = document.getElementById("pageDiv");
          console.log("返回的结果中的页码对象中的totalPage属性值：" + res.page.totalPage);
          let totalPage = res.page.totalPage;
          console.log("返回结果中的页码对象中的limit的属性值：" + res.page.limit);
          let limit = res.page.limit;
          let totalCount = res.page.totalCount;
          let firstPageA = document.createElement("a");
          firstPageA.setAttribute("id","first");
          firstPageA.setAttribute("href","javascript:void(0)");
          firstPageA.innerHTML = "首页&nbsp&nbsp";
          firstPageA.addEventListener("click",queryConsumePage);
          pageDiv.appendChild(firstPageA);
          for(let i = 1 ; i <= totalPage ; i++){
              let pageA = document.createElement("a");
              pageA.setAttribute("id",""+i);
              pageA.setAttribute("href","javascript:void(0)");
              pageA.innerHTML = ""+i+"&nbsp&nbsp";
              pageA.addEventListener("click",queryConsumePage);
              pageDiv.appendChild(pageA);
          }
          let lastPageA = document.createElement("a");
          lastPageA.setAttribute("id","last");
          lastPageA.setAttribute("href","javascript:void(0)");
          lastPageA.innerHTML = "&nbsp&nbsp最后一页";
          lastPageA.addEventListener("click",queryConsumePage);
          pageDiv.appendChild(lastPageA);
        }
        /**
         * 条件查询消费内容信息
         */
        function queryConsumePageWithOption() {
            clearConsumeTbody();
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const queryParams = {
                "startDate":startDate,
                "endDate":endDate,
                "page":{
                    "currentPage":this.id,
                    "limit":10
                }
            };
            const url = "/vcoffee/consume/queryConsume";
            const xhr = new XMLHttpRequest();
            xhr.open("POST",url,true);
            xhr.setRequestHeader("content-Type","application/json");
            xhr.onload = function () {
                let res = JSON.parse(xhr.responseText);
                if(res.code === 1000){
                    console.log(res.message);
                    drawConsumeTbody(res);
                }else{
                    console.error("条件查询消费分页信息报错，" + res.message);
                    window.location.href = "/error/error.html";
                }
            };
            xhr.onerror = function () {
                console.error("条件查询消费分页信息报错，" + JSON.parse(xhr.responseText).message);
                window.location.href = "/error/error.html";
            };
            xhr.send(JSON.stringify(queryParams));
        }

        /**
         * 条件查询消费分页数据
         */
        function drawConsumePageDivWithOption(res) {
            let pageDiv = document.getElementById("pageDiv");
            console.log("返回的结果中的页码对象中的totalPage属性值：" + res.page.totalPage);
            let totalPage = res.page.totalPage;
            console.log("返回结果中的页码对象中的limit的属性值：" + res.page.limit);
            let totalCount = res.page.totalCount;
            let firstPageA = document.createElement("a");
            firstPageA.setAttribute("id","first");
            firstPageA.setAttribute("href","javascript:void(0)");
            firstPageA.innerHTML = "首页&nbsp&nbsp";
            firstPageA.addEventListener("click",queryConsumePageWithOption);
            pageDiv.appendChild(firstPageA);
            for (let i = 1 ; i <= totalPage ; i++){
                let pageA = document.createElement("a");
                pageA.setAttribute("id",""+i);
                pageA.setAttribute("href","javascript:void(0)");
                pageA.innerHTML = ""+i+"&nbsp&nbsp";
                pageA.addEventListener("click",queryConsumePageWithOption);
                pageDiv.appendChild(pageA);
            }
            let lastPageA = document.createElement("a");
            lastPageA.setAttribute("id","last");
            lastPageA.setAttribute("href","javascript:void(0)");
            lastPageA.innerHTML = "&nbsp&nbsp最后一页";
            lastPageA.addEventListener("click",queryConsumePageWithOption);
            pageDiv.appendChild(lastPageA);
        }

        /**
         * 跳转到新增设备页面
         */
        function toAddConsume() {
            window.location.href = "/consume/addConsume.html";
        }
        /**
         * 返回主页面
         */
        function back() {
            window.location.href = "/home/home.html";
        }
    </script>
</head>
<body background="/picture/welcome1.jpg" style="background-repeat: no-repeat;background-size: 100% 100%;background-attachment: fixed;">
<div align="center">
    <h2>
        <input type="text" id="userName" name="userName" placeholder="用户姓名" readonly="readonly"/>的账户
    </h2>
</div>
<div align="center">
    <h2 id="normal">
        在<input type="text" id="companyName" name="companyName" placeholder="公司名称" readonly="readonly"/>公司工作
    </h2>
</div>
<div></div>
<div></div>
<form class="pure-form" method="post">
     <fieldset>
         <input type="date" id="startDate" name="startDate" value="1900/01/01" placeholder="开始日期"/>
         <input type="date" id="endDate" name="endDate" value="1900/01/01" placeholder="结束日期"/>
         <button type="button" class="pure-button pure-button-primary" onclick="queryConsume()">查询</button>
         <button type="reset" class="pure-button pure-button-primary">取消</button>
         <button type="button" class="pure-button pure-button-primary" onclick="back()">返回</button>
         <button type="button" class="pure-button pure-button-primary" onclick="toAddConsume()">新增</button>
     </fieldset>
 </form>
 <table class="pure-table pure-table-bordered" align="center">
     <thead align="center">
         <tr>
             <td>&nbsp&nbsp</td>
             <td>序号</td>
             <td>操作类型</td>
             <td>操作金额</td>
             <td>操作日期</td>
             <td>操作者</td>
         </tr>
     </thead>
     <tbody id="consumeTbody" align="center">

     </tbody>
 </table>
<div id="pageDiv" align="center">

</div>
</body>
</html>