<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>查询用户页面</title>
    <link rel="stylesheet" type="text/css" href="/css/pure-min.css">
    <script type="text/javascript">
        function toUpdateUser() {
            window.location.href = "/user/updateUser.html?"+this.id;
        }

        function deleteUser() {
          const url = "/vcoffee/user/deleteUser";
          const delParam = {
            "id":this.id
          };
          const xhr = new XMLHttpRequest();
          xhr.open("POST",url,true);
          xhr.setRequestHeader("content-Type","application/json");
          xhr.onload = function () {
            let res = JSON.parse(xhr.responseText);
            if(res.code === 1000){
                alert(res.message);
                window.location.href = "/user/queryUser.html";
            }else{
                console.error("删除用户报错，" + res.message);
                window.location.href = "/error/error.html";
            }
          };
          xhr.onerror = function () {
              console.error("删除用户报错，" + JSON.parse(xhr.responseText).message);
              window.location.href = "/error/error.html";
          };
          xhr.send(JSON.stringify(delParam));
        }

        function queryUserPage() {
            clearUserTbody();
            const url = "/vcoffee/user/findAllUsers";
            if(this.id === "first"){
                this.id = 1;
            }else if(this.id === "last"){
                this.id = this.page.totalPage;
            }
            const params = {
              "currentPage":this.id,
              "limit":10
            };
            const xhr = new XMLHttpRequest();
            xhr.open("POST",url,true);
            xhr.setRequestHeader("content-Type","application/json");
            xhr.onload = function () {
                let res = JSON.parse(xhr.responseText);
                if(res.code === 1000){
                    for(let i = 0 ; i < res.data.length ; i++){
                        let rowElement = document.createElement("tr");

                        let checkboxCell = document.createElement("td");
                        let checkBox = document.createElement("input");
                        checkBox.setAttribute("type","checkbox");
                        checkBox.setAttribute("name","idCheckBox");
                        checkBox.setAttribute("id","idCheckBox");
                        checkboxCell.appendChild(checkBox);
                        rowElement.appendChild(checkboxCell);

                        let idCell = document.createElement("td");
                        idCell.innerHTML = res.data[i].id;
                        rowElement.appendChild(idCell);

                        let userNameCell = document.createElement("td");
                        userNameCell.innerHTML = res.data[i].userName;
                        rowElement.appendChild(userNameCell);

                        let telephoneNumberCell = document.createElement("td");
                        telephoneNumberCell.innerHTML = res.data[i].telephoneNumber;
                        rowElement.appendChild(telephoneNumberCell);

                        let emailCell = document.createElement("td");
                        emailCell.innerHTML = res.data[i].email;
                        rowElement.appendChild(emailCell);

                        let isAdminCell = document.createElement("td");
                        isAdminCell.innerHTML = res.data[i].isAdmin;
                        rowElement.appendChild(isAdminCell);

                        let companyNameCell = document.createElement("td");
                        companyNameCell.innerHTML = res.data[i].companyName;
                        rowElement.appendChild(companyNameCell);

                        let equipmentNameCell = document.createElement("td");
                        equipmentNameCell.innerHTML = res.data[i].equipmentName;
                        rowElement.appendChild(equipmentNameCell);

                        let operateCell = document.createElement("td");

                        let btnUpdate = document.createElement("button");
                        btnUpdate.setAttribute("type","button");
                        btnUpdate.setAttribute("value","修改");
                        btnUpdate.setAttribute("id",res.data[i].id);
                        btnUpdate.addEventListener("click",toUpdateUser);
                        btnUpdate.innerHTML = "修改";
                        operateCell.appendChild(btnUpdate);

                        let btnDel = document.createElement("button");
                        btnDel.setAttribute("type","button");
                        btnDel.setAttribute("value","删除");
                        btnDel.setAttribute("id",res.data[i].id);
                        btnDel.addEventListener("click",deleteUser);
                        btnDel.innerHTML = "删除";
                        operateCell.appendChild(btnDel);

                        rowElement.appendChild(operateCell);

                        let tbody = document.getElementById("userTbody");
                        tbody.appendChild(rowElement);

                    }
                }else{
                    console.error("分页查询用户报错" + JSON.parse(xhr.responseText).message);
                    window.location.href = "/error/error.html";
                }
            };
            xhr.onerror = function () {
              console.error("分页查询用户报错" + JSON.parse(xhr.responseText).message);
              window.location.href = "/error/error.html";
            };
            xhr.send(JSON.stringify(params));
        }

        window.onload = function () {
            const url = "/vcoffee/user/findAllUsers";
            const xhr = new XMLHttpRequest();
            const param = {
              "currentPage":1,
              "limit":10
            };
            xhr.open("POST",url,true);
            xhr.setRequestHeader("content-Type","application/json");
            xhr.onload = function () {
              let res = JSON.parse(xhr.responseText);
              if(res.code === 1000){
                  alert(res.message);
                  for(let i = 0 ; i < res.data.length ; i++){
                      let rowElement = document.createElement("tr");
                      let checkboxCell = document.createElement("td");
                      let checkBox = document.createElement("input");
                      checkBox.setAttribute("type","checkbox");
                      checkBox.setAttribute("name","idCheckBox");
                      checkBox.setAttribute("id","idCheckBox");
                      checkboxCell.appendChild(checkBox);
                      rowElement.appendChild(checkboxCell);

                      let idCell = document.createElement("td");
                      idCell.innerHTML = res.data[i].id;
                      rowElement.appendChild(idCell);

                      let userNameCell = document.createElement("td");
                      userNameCell.innerHTML = res.data[i].userName;
                      rowElement.appendChild(userNameCell);

                      let telephoneNumberCell = document.createElement("td");
                      telephoneNumberCell.innerHTML = res.data[i].telephoneNumber;
                      rowElement.appendChild(telephoneNumberCell);

                      let emailCell = document.createElement("td");
                      emailCell.innerHTML = res.data[i].email;
                      rowElement.appendChild(emailCell);

                      let isAdminCell = document.createElement("td");
                      isAdminCell.innerHTML = res.data[i].isAdmin;
                      rowElement.appendChild(isAdminCell);

                      let companyNameCell = document.createElement("td");
                      companyNameCell.innerHTML = res.data[i].companyName;
                      rowElement.appendChild(companyNameCell);

                      let equipmentNameCell = document.createElement("td");
                      equipmentNameCell.innerHTML = res.data[i].equipmentName;
                      rowElement.appendChild(equipmentNameCell);

                      let operateCell = document.createElement("td");

                      let btnUpdate = document.createElement("button");
                      btnUpdate.setAttribute("type","button");
                      btnUpdate.setAttribute("value","修改");
                      btnUpdate.setAttribute("id",res.data[i].id);
                      btnUpdate.addEventListener("click",toUpdateUser);
                      btnUpdate.innerHTML = "修改";
                      operateCell.appendChild(btnUpdate);

                      let btnDel = document.createElement("button");
                      btnDel.setAttribute("type","button");
                      btnDel.setAttribute("value","删除");
                      btnDel.setAttribute("id",res.data[i].id);
                      btnDel.addEventListener("click",deleteUser);
                      btnDel.innerHTML = "删除";
                      operateCell.appendChild(btnDel);

                      rowElement.appendChild(operateCell);

                      let tbody = document.getElementById("userTbody");
                      tbody.appendChild(rowElement);
                  }
                  let pageDiv = document.getElementById("pageDiv");
                  alert("返回结果中的页码对象中的totalPage属性值：" + res.page.totalPage);
                  let totalPage = res.page.totalPage;
                  alert("返回结果中的页码对象中的limit属性值：" + res.page.limit);
                  let limit = res.page.limit;
                  alert("返回结果中的页码对象中的totalCount属性值：" + res.page.totalCount);
                  let firstPageA = document.createElement("a");
                  firstPageA.setAttribute("id","first");
                  firstPageA.setAttribute("href","javascript:void(0)");
                  firstPageA.innerHTML = "首页&nbsp&nbsp";
                  firstPageA.addEventListener("click",queryUserPage);
                  pageDiv.appendChild(firstPageA);
                  for(let i = 1 ; i <= totalPage ; i++){
                      let pageA = document.createElement("a");
                      pageA.setAttribute("id",""+i);
                      pageA.setAttribute("href","javascript:void(0)");
                      pageA.innerHTML = ""+i+"&nbsp&nbsp";
                      pageA.addEventListener("click",queryUserPage);
                      pageDiv.appendChild(pageA);
                  }
                  let lastPageA = document.createElement("a");
                  lastPageA.setAttribute("id","last");
                  lastPageA.setAttribute("href","javascript:void(0)");
                  lastPageA.innerHTML = "&nbsp&nbsp最后一页";
                  lastPageA.addEventListener("click",queryUserPage);
                  pageDiv.appendChild(lastPageA);
              }else{
                  console.error("查询用户信息错误，" + res.message);
                  window.location.href = "/error/error.html";
              }
            };
            xhr.onerror = function () {
                console.error("查询用户信息错误，" + JSON.parse(xhr.responseText).message);
                window.location.href = "/error/error.html";
            };
            xhr.send(JSON.stringify(param));
        };
    function batchDeleteUser() {
      let ids = [];
      let data = document.getElementById("idCheckBox");
      for(let i = 0 ; i < data.length ; i++){
          if(data[i].checked === true){
              ids.push(data[i].id);
          }
      }
      const batchDeleteParams = {
        "ids":ids
      };
      const url = "/vcoffee/user/batchDeleteUsers";
      const xhr = new XMLHttpRequest();
      xhr.open("POST",url,true);
      xhr.setRequestHeader("content-Type","application/json");
      xhr.onload = function () {
        let res = JSON.parse(xhr.responseText);
        if(res.code === 1000){
            alert(res.message);
            window.location.href = "/user/queryUser.html";
        }else{
           console.error("批量删除用户信息报错" + res.message);
           window.location.href = "/error/error.html";
        }
      };
      xhr.onerror = function () {
          console.error("批量删除用户信息报错" + JSON.parse(xhr.responseText).message);
          window.location.href = "/error/error.html";
      };
      xhr.send(JSON.stringify(batchDeleteParams));
    }

    function toInsertUser() {
      window.location.href = "/user/addUser.html";
    }

        function clearUserTbody() {
            let tbody = document.getElementById("userTbody");
            tbody.innerText = "";
        }

        function clearUserPageDiv() {
            let pageDiv = document.getElementById("pageDiv");
            pageDiv.innerHTML = "";
        }

        function queryUserPageWithOption() {
            clearUserTbody();
            const userName = document.getElementById("userName").value;
            const queryParam = {
              "userName":userName,
              "page":{
                  "currentPage":this.id,
                  "limit":10
              }
            };
            const url = "/vcoffee/user/queryUser";
            if(this.id === "first"){
                this.id = 1;
            }else if(this.id === "last"){
                this.id = this.page.totalPage;
            }
            const xhr = new XMLHttpRequest();
            xhr.open("POST",url,true);
            xhr.setRequestHeader("content-Type","application/json");
            xhr.onload = function () {
              let res = JSON.parse(xhr.responseText);
              if(res.code === 1000){
                  alert(res.message);
                  for(let i = 0 ; i < res.data.length ; i++){
                      let rowElement = document.createElement("tr");

                      let checkboxCell = document.createElement("td");
                      let checkBox = document.createElement("input");
                      checkBox.setAttribute("type","checkbox");
                      checkBox.setAttribute("name","idCheckBox");
                      checkBox.setAttribute("id",res.data[i].id);
                      checkboxCell.appendChild(checkBox);
                      rowElement.appendChild(checkboxCell);

                      let idCell = document.createElement("td");
                      idCell.innerHTML = res.data[i].id;
                      rowElement.appendChild(idCell);

                      let userNameCell = document.createElement("td");
                      userNameCell.innerHTML = res.data[i].userName;
                      rowElement.appendChild(userNameCell);

                      let telephoneNumberCell = document.createElement("td");
                      telephoneNumberCell.innerHTML = res.data[i].telephoneNumber;
                      rowElement.appendChild(telephoneNumberCell);

                      let emailCell = document.createElement("td");
                      emailCell.innerHTML = res.data[i].email;
                      rowElement.appendChild(emailCell);

                      let isAdminCell = document.createElement("td");
                      isAdminCell.innerHTML = res.data[i].isAdmin;
                      rowElement.appendChild(isAdminCell);

                      let companyNameCell = document.createElement("td");
                      companyNameCell.innerHTML = res.data[i].companyName;
                      rowElement.appendChild(companyNameCell);

                      let equipmentNameCell = document.createElement("td");
                      equipmentNameCell.innerHTML = res.data[i].equipmentName;
                      rowElement.appendChild(equipmentNameCell);

                      let operateCell = document.createElement("td");

                      let btnUpdate = document.createElement("button");
                      btnUpdate.setAttribute("type","button");
                      btnUpdate.setAttribute("value","修改");
                      btnUpdate.setAttribute("id",res.data[i].id);
                      btnUpdate.addEventListener("click",toUpdateUser);
                      btnUpdate.innerHTML = "修改";
                      operateCell.appendChild(btnUpdate);

                      let btnDel = document.createElement("button");
                      btnDel.setAttribute("type","button");
                      btnDel.setAttribute("value","删除");
                      btnDel.setAttribute("id",res.data[i].id);
                      btnDel.addEventListener("click",deleteUser);
                      btnDel.innerHTML = "删除";
                      operateCell.appendChild(btnDel);

                      rowElement.appendChild(operateCell);

                      let tbody = document.getElementById("userTbody");
                      tbody.appendChild(rowElement);
                  }
              }else{
                  console.error("条件查询用户分页信息报错，" + res.message);
                  window.location.href = "/error/error.html";
              }
            };
            xhr.onerror = function () {
                console.error("条件查询用户分页信息报错，" + res.message);
                window.location.href = "/error/error.html";
            };
            xhr.send(JSON.stringify(queryParam));
        }

    function queryUser() {
      const userName = document.getElementById("userName").value;
      const  url = "/vcoffee/user/queryUser";
      const queryParam = {
        "userName":userName
      };
      const xhr = new XMLHttpRequest();
      xhr.open("POST",url,true);
      xhr.setRequestHeader("content-Type","application/json");
      xhr.onload = function () {
        let res = JSON.parse(xhr.responseText);
        if(res.code === 1000){
            alert(res.message);
            clearUserTbody();
            for(let i = 0 ; i < res.data.length ; i++){
                let rowElement = document.createElement("tr");

                let checkboxCell = document.createElement("td");
                let checkBox = document.createElement("input");
                checkBox.setAttribute("type","checkbox");
                checkBox.setAttribute("name","idCheckBox");
                checkBox.setAttribute("id",res.data[i].id);
                checkboxCell.appendChild(checkBox);
                rowElement.appendChild(checkboxCell);

                let idCell = document.createElement("td");
                idCell.innerHTML = res.data[i].id;
                rowElement.appendChild(idCell);

                let userNameCell = document.createElement("td");
                userNameCell.innerHTML = res.data[i].userName;
                rowElement.appendChild(userNameCell);

                let telephoneNumberCell = document.createElement("td");
                telephoneNumberCell.innerHTML = res.data[i].telephoneNumber;
                rowElement.appendChild(telephoneNumberCell);

                let emailCell = document.createElement("td");
                emailCell.innerHTML = res.data[i].email;
                rowElement.appendChild(emailCell);

                let isAdminCell = document.createElement("td");
                isAdminCell.innerHTML = res.data[i].isAdmin;
                rowElement.appendChild(isAdminCell);

                let companyNameCell = document.createElement("td");
                companyNameCell.innerHTML = res.data[i].companyName;
                rowElement.appendChild(companyNameCell);

                let equipmentNameCell = document.createElement("td");
                equipmentNameCell.innerHTML = res.data[i].equipmentName;
                rowElement.appendChild(equipmentNameCell);

                let operateCell = document.createElement("td");

                let btnUpdate = document.createElement("button");
                btnUpdate.setAttribute("type","button");
                btnUpdate.setAttribute("value","修改");
                btnUpdate.setAttribute("id",res.data[i].id);
                btnUpdate.addEventListener("click",toUpdateUser);
                btnUpdate.innerHTML = "修改";
                operateCell.appendChild(btnUpdate);

                let btnDel = document.createElement("button");
                btnDel.setAttribute("type","button");
                btnDel.setAttribute("value","删除");
                btnDel.setAttribute("id",res.data[i].id);
                btnDel.addEventListener("click",deleteUser);
                btnDel.innerHTML = "删除";
                operateCell.appendChild(btnDel);

                rowElement.appendChild(operateCell);

                let tbody = document.getElementById("userTbody");
                tbody.appendChild(rowElement);
            }
            clearUserPageDiv();
            let pageDiv = document.getElementById("pageDiv");
            alert("返回结果中的页码对象中的totalPage属性值：" + res.page.totalPage);
            let totalPage = res.page.totalPage;
            alert("返回结果中的页码对象中的limit属性值：" + res.page.limit);
            let limit = res.page.limit;
            alert("返回结果中的页码对象中的totalCount属性值：" + res.page.totalCount);
            let firstPageA = document.createElement("a");
            firstPageA.setAttribute("id","first");
            firstPageA.setAttribute("href","javascript:void(0)");
            firstPageA.innerHTML = "首页&nbsp&nbsp";
            firstPageA.addEventListener("click",queryUserPageWithOption);
            pageDiv.appendChild(firstPageA);
            for(let i = 1 ; i <= totalPage ; i++){
                let pageA = document.createElement("a");
                pageA.setAttribute("id",""+i);
                pageA.setAttribute("href","javascript:void(0)");
                pageA.innerHTML = ""+i+"&nbsp&nbsp";
                pageA.addEventListener("click",queryUserPageWithOption);
                pageDiv.appendChild(pageA);
            }
            let lastPageA = document.createElement("a");
            lastPageA.setAttribute("id","last");
            lastPageA.setAttribute("href","javascript:void(0)");
            lastPageA.innerHTML = "&nbsp&nbsp最后一页";
            lastPageA.addEventListener("click",queryUserPageWithOption);
            pageDiv.appendChild(lastPageA);

        }else{
          console.error("条件查询用户信息报错，"  + res.message);
          window.location.href = "/error/error.html";
        }
      };
      xhr.onerror = function () {
          console.error("条件查询用户信息报错，"  + JSON.parse(xhr.responseText).message);
          window.location.href = "/error/error.html";
      };
      xhr.send(JSON.stringify(queryParam));
    }
    function back() {
       window.location.href = "/home/home.html";
    }

    </script>
</head>
<body background="/picture/welcome.jpg" style="background-repeat: no-repeat;background-size: 100% 100%;background-attachment: fixed;">
<form class="pure-form" method="post">
    <fieldset>
        <input type="text" id="userName" name="userName" placeholder="用户名称">
        <button type="button" class="pure-button pure-button-primary" onclick="queryUser()">查询</button>
        <button type="reset" class="pure-button pure-button-primary">取消</button>
        <button type="button" class="pure-button pure-button-primary" onclick="back()">返回</button>
        <button type="button" class="pure-button pure-button-primary" onclick="toInsertUser()">新增</button>
        <button type="button" class="pure-button pure-button-primary" onclick="batchDeleteUser()">批量删除</button>
    </fieldset>
</form>
<table class="pure-table pure-table-bordered" align="center">
    <thead align="center">
       <tr>
           <td>&nbsp;&nbsp;</td>
           <td>序号</td>
           <td>用户姓名</td>
           <td>用户联系方式</td>
           <td>用户电子邮箱</td>
           <td>是否有管理权限</td>
           <td>所在公司名称</td>
           <td>可使用设备名称</td>
           <td>操作</td>
       </tr>
    </thead>
    <tbody id="userTbody" align="center">

    </tbody>
</table>
<div id="pageDiv" align="center">

</div>
</body>
</html>